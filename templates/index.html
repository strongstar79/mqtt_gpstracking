<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS íŠ¸ë˜í‚¹</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .header .info {
            font-size: 14px;
            opacity: 0.9;
        }
        
        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 1000;
            text-align: center;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats {
            position: absolute;
            top: 100px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 12px;
        }
        
        .stats div {
            margin: 5px 0;
        }
        
        .stats .label {
            font-weight: bold;
            color: #667eea;
        }
        
        .file-selector {
            position: absolute;
            top: 100px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 250px;
        }
        
        .file-selector select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .file-selector input[type="file"] {
            width: 100%;
            margin-bottom: 10px;
            font-size: 12px;
        }
        
        .file-selector button {
            width: 100%;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .file-selector button:hover {
            background: #5568d3;
        }
        
        .file-selector .label {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            display: block;
            font-size: 12px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="page-title">ğŸ“ GPS íŠ¸ë˜í‚¹</h1>
            <div class="info" id="page-info">MQTT GPS ì¢Œí‘œ ì‹¤ì‹œê°„ ì¶”ì  (ìµœì†Œ 5m ê°„ê²© í•„í„°ë§)</div>
        </div>
        
        <div class="file-selector">
            <span class="label">ë¡œê·¸ íŒŒì¼ ì„ íƒ:</span>
            <select id="file-select">
                <option value="">ë¡œë”© ì¤‘...</option>
            </select>
            <input type="file" id="file-upload" accept=".log" style="display: none;">
            <button onclick="document.getElementById('file-upload').click()">ìƒˆ íŒŒì¼ ì—…ë¡œë“œ</button>
        </div>
        
        <div id="map"></div>
        
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <div>GPS ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>
        
        <div class="stats" id="stats" style="display: none;">
            <div><span class="label">ì´ í¬ì¸íŠ¸:</span> <span id="total-points">0</span></div>
            <div><span class="label">ì›ë³¸ í¬ì¸íŠ¸:</span> <span id="original-points">0</span></div>
            <div><span class="label">í˜„ì¬ ìœ„ì¹˜:</span> <span id="current-point">-</span></div>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // ì§€ë„ ì´ˆê¸°í™”
        const map = L.map('map').setView([35.9448, 126.5565], 15);
        
        // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // í´ë¦¬ë¼ì¸ê³¼ ë§ˆì»¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let polyline = null;
        let markers = [];
        let routePoints = [];
        let startMarker = null;
        let endMarker = null;
        let currentFilename = '';
        
        // íŒŒì¼ ëª©ë¡ ë¡œë“œ
        async function loadFileList() {
            try {
                const response = await fetch('/api/files');
                if (!response.ok) {
                    throw new Error('íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                const data = await response.json();
                const select = document.getElementById('file-select');
                select.innerHTML = '';
                
                if (data.files && data.files.length > 0) {
                    data.files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file.path;
                        option.textContent = file.name;
                        select.appendChild(option);
                    });
                    // ì²« ë²ˆì§¸ íŒŒì¼ì„ ìë™ìœ¼ë¡œ ì„ íƒí•˜ê³  ë¡œë“œ
                    if (data.files.length > 0) {
                        select.value = data.files[0].path;
                        currentFilename = data.files[0].path;
                        loadGPSData(data.files[0].path);
                    }
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'íŒŒì¼ ì—†ìŒ';
                    select.appendChild(option);
                    // ê¸°ë³¸ íŒŒì¼ ì‹œë„
                    loadGPSData('mqtt_messages_2025-12-11_153030_1_short.log');
                }
            } catch (error) {
                console.error('Error loading file list:', error);
                // íŒŒì¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ íŒŒì¼ ì‹œë„
                loadGPSData('mqtt_messages_2025-12-11_153030_1_short.log');
            }
        }
        
        // íŒŒì¼ ì„ íƒ ë³€ê²½ ì‹œ ìë™ ë¡œë“œ
        document.getElementById('file-select').addEventListener('change', function(e) {
            const filename = e.target.value;
            if (filename) {
                currentFilename = filename;
                loadGPSData(filename);
            }
        });
        
        // íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('file-upload').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('loading').innerHTML = 
                    '<div class="loading-spinner"></div><div>íŒŒì¼ ì—…ë¡œë“œ ì¤‘...</div>';
                
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (response.ok) {
                    // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ë° ì—…ë¡œë“œí•œ íŒŒì¼ ìë™ ì„ íƒ
                    await loadFileList();
                } else {
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: #f44336;">ì—…ë¡œë“œ ì‹¤íŒ¨: ' + data.error + '</div>';
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #f44336;">íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        });
        
        // GPS ë°ì´í„° ë¡œë“œ
        async function loadGPSData(filename = '') {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('loading').innerHTML = 
                '<div class="loading-spinner"></div><div>GPS ë°ì´í„° ë¡œë”© ì¤‘...</div>';
            
            try {
                const url = filename ? `/api/track?filename=${encodeURIComponent(filename)}` : '/api/track';
                const response = await fetch(url);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜' }));
                    throw new Error(errorData.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const data = await response.json();
                
                if (data.points && data.points.length > 0) {
                    // EQUIP_TYPEê³¼ EQUIP_IDë¡œ ì œëª© ì—…ë°ì´íŠ¸
                    const equipType = data.equip_type || '';
                    const equipId = data.equip_id || '';
                    let title = 'ğŸ“ GPS íŠ¸ë˜í‚¹';
                    let info = 'MQTT GPS ì¢Œí‘œ ì‹¤ì‹œê°„ ì¶”ì  (ìµœì†Œ 5m ê°„ê²© í•„í„°ë§)';
                    
                    if (equipType || equipId) {
                        title = `ğŸš› GPS íŠ¸ë˜í‚¹ - ${equipType} ${equipId}`;
                        info = `${equipType} ${equipId} | MQTT GPS ì¢Œí‘œ ì‹¤ì‹œê°„ ì¶”ì  (ìµœì†Œ 5m ê°„ê²© í•„í„°ë§)`;
                    }
                    
                    document.getElementById('page-title').textContent = title;
                    document.getElementById('page-info').textContent = info;
                    document.title = title;
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    document.getElementById('total-points').textContent = data.total_points;
                    document.getElementById('original-points').textContent = data.original_points;
                    document.getElementById('stats').style.display = 'block';
                    
                    // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
                    if (startMarker) map.removeLayer(startMarker);
                    if (endMarker) map.removeLayer(endMarker);
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    
                    // ê²½ë¡œ í¬ì¸íŠ¸ ìƒì„±
                    routePoints = data.points.map(point => [point.lat, point.lon]);
                    
                    // í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
                    if (polyline) {
                        map.removeLayer(polyline);
                    }
                    
                    polyline = L.polyline(routePoints, {
                        color: '#667eea',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    // ì‹œì‘ ë§ˆì»¤ (ë¤í”„íŠ¸ëŸ­ ì•„ì´ì½˜)
                    const startIcon = L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2276/2276253.png',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    });
                    
                    startMarker = L.marker(routePoints[0], { icon: startIcon }).addTo(map);
                    const firstPoint = data.points[0];
                    let startPopup = '<b>ğŸš› ì‹œì‘ì </b><br>';
                    if (firstPoint.equip_type || firstPoint.equip_id) {
                        startPopup += `ì¥ë¹„: ${firstPoint.equip_type || ''} ${firstPoint.equip_id || ''}<br>`;
                    }
                    startPopup += 'ì‹œê°„: ' + firstPoint.timestamp + '<br>' +
                        'ì¢Œí‘œ: ' + firstPoint.lat.toFixed(6) + ', ' + firstPoint.lon.toFixed(6) + '<br>' +
                        'ì†ë„: ' + firstPoint.kph + ' km/h<br>' +
                        'ê³ ë„: ' + firstPoint.alt.toFixed(2) + ' m';
                    startMarker.bindPopup(startPopup);
                    
                    // ë ë§ˆì»¤ (ë¤í”„íŠ¸ëŸ­ ì•„ì´ì½˜)
                    const endIcon = L.icon({
                        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2276/2276253.png',
                        iconSize: [40, 40],
                        iconAnchor: [20, 40],
                        popupAnchor: [0, -40]
                    });
                    
                    endMarker = L.marker(routePoints[routePoints.length - 1], { icon: endIcon }).addTo(map);
                    const lastPoint = data.points[data.points.length - 1];
                    let endPopup = '<b>ğŸš› ì¢…ë£Œì </b><br>';
                    if (lastPoint.equip_type || lastPoint.equip_id) {
                        endPopup += `ì¥ë¹„: ${lastPoint.equip_type || ''} ${lastPoint.equip_id || ''}<br>`;
                    }
                    endPopup += 'ì‹œê°„: ' + lastPoint.timestamp + '<br>' +
                        'ì¢Œí‘œ: ' + lastPoint.lat.toFixed(6) + ', ' + lastPoint.lon.toFixed(6) + '<br>' +
                        'ì†ë„: ' + lastPoint.kph + ' km/h<br>' +
                        'ê³ ë„: ' + lastPoint.alt.toFixed(2) + ' m';
                    endMarker.bindPopup(endPopup);
                    
                    // ì¤‘ê°„ í¬ì¸íŠ¸ ë§ˆì»¤ (ì¼ë¶€ë§Œ í‘œì‹œ)
                    const step = Math.max(1, Math.floor(routePoints.length / 20)); // ìµœëŒ€ 20ê°œ ë§ˆì»¤
                    for (let i = 1; i < routePoints.length - 1; i += step) {
                        const marker = L.circleMarker(routePoints[i], {
                            radius: 5,
                            fillColor: '#667eea',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);
                        
                        const point = data.points[i];
                        let popup = '<b>í¬ì¸íŠ¸ #' + (i + 1) + '</b><br>';
                        if (point.equip_type || point.equip_id) {
                            popup += `ì¥ë¹„: ${point.equip_type || ''} ${point.equip_id || ''}<br>`;
                        }
                        popup += 'ì‹œê°„: ' + point.timestamp + '<br>' +
                            'ì¢Œí‘œ: ' + point.lat.toFixed(6) + ', ' + point.lon.toFixed(6) + '<br>' +
                            'ì†ë„: ' + point.kph + ' km/h<br>' +
                            'ê³ ë„: ' + point.alt.toFixed(2) + ' m';
                        marker.bindPopup(popup);
                        
                        markers.push(marker);
                    }
                    
                    // Pending ì§€ì  ë§ˆì»¤ (X ì•„ì´ì½˜)
                    if (data.pending_points && data.pending_points.length > 0) {
                        data.pending_points.forEach((pending, index) => {
                            const pendingIcon = L.divIcon({
                                className: 'pending-marker',
                                html: '<div style="background: #f44336; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">âœ•</div>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            });
                            
                            const pendingMarker = L.marker([pending.lat, pending.lon], { icon: pendingIcon }).addTo(map);
                            
                            let pendingPopup = '<b>âš ï¸ MQTT Pending ì§€ì  #' + (index + 1) + '</b><br>';
                            pendingPopup += 'ì¢Œí‘œ: ' + pending.lat.toFixed(6) + ', ' + pending.lon.toFixed(6) + '<br>';
                            pendingPopup += '<hr style="margin: 5px 0;">';
                            pendingPopup += '<b>Pending ì „:</b> ' + (pending.timestamp_before || 'N/A') + '<br>';
                            pendingPopup += '<b>Pending ë°œìƒ:</b> ' + (pending.pending_timestamp || 'N/A') + '<br>';
                            pendingPopup += '<b>Pending í›„:</b> ' + (pending.timestamp_after || 'N/A') + '<br>';
                            pendingPopup += '<hr style="margin: 5px 0;">';
                            pendingPopup += '<b style="color: #f44336;">Pending ìœ ì§€ ì‹œê°„:</b> ' + (pending.duration || 'N/A');
                            
                            pendingMarker.bindPopup(pendingPopup);
                            markers.push(pendingMarker);
                        });
                    }
                    
                    // ì§€ë„ ë²”ìœ„ ì¡°ì •
                    map.fitBounds(polyline.getBounds(), { padding: [50, 50] });
                    
                    // í˜„ì¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                    document.getElementById('current-point').textContent = 
                        lastPoint.lat.toFixed(6) + ', ' + lastPoint.lon.toFixed(6);
                    
                    // ë¡œë”© ìˆ¨ê¸°ê¸°
                    document.getElementById('loading').style.display = 'none';
                } else {
                    document.getElementById('loading').innerHTML = 
                        '<div style="color: #f44336;">GPS ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            } catch (error) {
                console.error('Error loading GPS data:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #f44336;">ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message + '</div>';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ ëª©ë¡ ë¡œë“œ (ìë™ìœ¼ë¡œ ì²« ë²ˆì§¸ íŒŒì¼ ë¡œë“œ)
        loadFileList();
    </script>
</body>
</html>

